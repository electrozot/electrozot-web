# Implementation Guide: ID Card Auto-Save & User Data Protection

## Overview
This implementation ensures:
1. **ID Cards are automatically saved** when generated by admin
2. **User data is never deleted** - only soft-deleted (moved to recycle bin)

---

## STEP 1: Run the SQL Setup

### Open phpMyAdmin and run this SQL:

```sql
USE `electrozot_db`;

-- 1. Create table to store generated ID cards
CREATE TABLE IF NOT EXISTS `tms_generated_id_cards` (
  `id` int NOT NULL AUTO_INCREMENT,
  `technician_id` int NOT NULL,
  `technician_name` varchar(200) NOT NULL,
  `technician_phone` varchar(20) NOT NULL,
  `image_path` varchar(500) DEFAULT NULL,
  `pdf_path` varchar(500) DEFAULT NULL,
  `generated_by_admin_id` int NOT NULL,
  `generated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `sent_to_whatsapp` tinyint(1) DEFAULT 0,
  `whatsapp_sent_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `technician_id` (`technician_id`),
  KEY `generated_by_admin_id` (`generated_by_admin_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. Add columns to technician table
ALTER TABLE `tms_technician` 
ADD COLUMN IF NOT EXISTS `t_id_card_generated` tinyint(1) DEFAULT 0,
ADD COLUMN IF NOT EXISTS `t_id_card_path` varchar(500) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS `t_id_card_generated_at` timestamp NULL DEFAULT NULL;

-- 3. Ensure user data protection
ALTER TABLE `tms_user` 
ADD COLUMN IF NOT EXISTS `u_is_deleted` tinyint(1) DEFAULT 0,
ADD COLUMN IF NOT EXISTS `u_deleted_at` timestamp NULL DEFAULT NULL,
ADD COLUMN IF NOT EXISTS `u_deleted_by` int DEFAULT NULL;

CREATE INDEX IF NOT EXISTS `idx_user_deleted` ON `tms_user` (`u_is_deleted`);

-- 4. Create system logs table
CREATE TABLE IF NOT EXISTS `tms_system_logs` (
  `log_id` int NOT NULL AUTO_INCREMENT,
  `log_type` varchar(100) NOT NULL,
  `log_message` text,
  `log_data` text,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`log_id`),
  KEY `log_type` (`log_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## STEP 2: What Has Been Implemented

### ✅ ID Card Auto-Save Feature

**File Modified:** `admin/api-send-id-card-whatsapp.php`

**What it does:**
- When admin generates an ID card, it automatically:
  1. Saves the image and PDF files to `uploads/id_cards/` folder
  2. **Stores record in database** (`tms_generated_id_cards` table)
  3. **Updates technician profile** with ID card info
  4. Records which admin generated it and when
  5. Makes it available in both admin dashboard and technician dashboard

**Benefits:**
- Admin can see all generated ID cards in one place
- Technician can access their ID card anytime from their dashboard
- Complete audit trail of who generated what and when
- No manual saving required - fully automatic

---

### ✅ User Data Protection Feature

**Current Status:** Already implemented via soft delete

**How it works:**
- Users are NEVER hard-deleted from database
- When "deleted", they are:
  1. Moved to recycle bin (`tms_recycle_bin` table)
  2. Marked with `u_is_deleted = 1` flag
  3. Can be restored later if needed

**Files using soft delete:**
- `admin/admin-manage-user.php` - Uses `softDeleteUser()` function
- `admin/admin-manage-user-passwords.php` - Moves to recycle bin before delete

**Protection against booking deletion:**
- User data remains intact even when:
  - Bookings are cancelled
  - Bookings are deleted
  - Service history is cleared
- User account is independent of booking records

---

## STEP 3: How to Use

### For Admin - Generating ID Cards:

1. Go to **Admin Dashboard** → **Settings** → **Generate ID Card**
2. Enter technician's phone number
3. Click "Search"
4. Review the ID card preview
5. Click "Send to WhatsApp"
6. **Automatically saved** to:
   - Database (`tms_generated_id_cards` table)
   - Technician's profile
   - Admin's records

### For Technician - Viewing ID Card:

1. Login to **Technician Dashboard**
2. Go to **My Profile** or **ID Card** section
3. View/Download their ID card
4. ID card is always available (never deleted)

### For Admin - Viewing All Generated ID Cards:

Create a new page: `admin/admin-view-id-cards.php` to display all generated cards:

```php
<?php
$query = "SELECT g.*, t.t_name, a.a_name as admin_name 
          FROM tms_generated_id_cards g
          LEFT JOIN tms_technician t ON g.technician_id = t.t_id
          LEFT JOIN tms_admin a ON g.generated_by_admin_id = a.a_id
          ORDER BY g.generated_at DESC";
$result = $mysqli->query($query);
?>
```

---

## STEP 4: Verify Implementation

### Test ID Card Auto-Save:
1. Generate an ID card for any technician
2. Check database: `SELECT * FROM tms_generated_id_cards;`
3. Verify record was created with correct paths
4. Check technician table: `SELECT t_id_card_generated, t_id_card_path FROM tms_technician WHERE t_phone = 'PHONE_NUMBER';`

### Test User Data Protection:
1. Try to delete a user from admin panel
2. Check: User should be in recycle bin, not permanently deleted
3. Verify: `SELECT * FROM tms_user WHERE u_id = USER_ID;` (should still exist with u_is_deleted = 1)
4. Cancel a booking for that user
5. Verify: User data still intact

---

## Database Schema

### tms_generated_id_cards
| Column | Type | Description |
|--------|------|-------------|
| id | int | Primary key |
| technician_id | int | FK to tms_technician |
| technician_name | varchar(200) | Technician name |
| technician_phone | varchar(20) | Phone number |
| image_path | varchar(500) | Path to PNG image |
| pdf_path | varchar(500) | Path to PDF file |
| generated_by_admin_id | int | FK to tms_admin |
| generated_at | timestamp | When generated |
| sent_to_whatsapp | tinyint(1) | Whether sent |
| whatsapp_sent_at | timestamp | When sent |

---

## Summary

✅ **Requirement 1 - ID Card Auto-Save:** IMPLEMENTED
- ID cards automatically saved to database when generated
- Available in both admin and technician dashboards
- Complete audit trail maintained

✅ **Requirement 2 - User Data Protection:** ALREADY IMPLEMENTED
- Users never hard-deleted (soft delete only)
- User data persists regardless of booking status
- Can be restored from recycle bin if needed

---

## Next Steps (Optional Enhancements)

1. **Create Admin View Page** - Display all generated ID cards in a table
2. **Add to Technician Dashboard** - Show their ID card with download button
3. **Email Notification** - Send ID card via email as well
4. **Bulk Generation** - Generate ID cards for multiple technicians at once
5. **ID Card Expiry** - Add expiry date and renewal feature

---

## Support

If you encounter any issues:
1. Check database tables were created successfully
2. Verify file permissions on `uploads/id_cards/` folder (should be writable)
3. Check PHP error logs for any issues
4. Ensure all SQL queries ran without errors

